services:
    php-cli:
        build: docker/php-cli
        container_name: 'statistics-for-strava-php-cli'
        volumes:
            - './:/var/www/'
        working_dir: /var/www
        environment:
            - PHP_CS_FIXER_IGNORE_ENV=true
            - IMPORT_AND_BUILD_SCHEDULE=* * * * *
            - PHP_IDE_CONFIG=phpstorm
        profiles:
            - on-demand
        networks:
            - statistics-for-strava-network
    app:
        build:
            context: ./
            dockerfile: docker/app/Dockerfile
        container_name: 'statistics-for-strava-app'
        volumes:
            - ./config/app:/var/www/config/app
            - ./build:/var/www/build
            - ./storage/database:/var/www/storage/database
            - ./storage/files:/var/www/storage/files
            - ./storage/gear-maintenance:/var/www/storage/gear-maintenance
            #- ./cron:/config/crontabs
        env_file: ".env.local"
        ports:
            - '8081:8080'
        networks:
            - statistics-for-strava-network

    ollama:
        image: ollama/ollama:latest
        container_name: 'statistics-for-strava-ollama'
        tty: true
        restart: unless-stopped
        volumes:
            - .:/code
            - ./ollama:/root/.ollama
        environment:
            - OLLAMA_KEEP_ALIVE=24h
            - OLLAMA_HOST=0.0.0.0
        ports:
            - '11434:11434'
        networks:
            - statistics-for-strava-network

    mercure:
      image: dunglas/mercure
      container_name: 'statistics-for-strava-mercure'
      restart: unless-stopped
      environment:
        # Uncomment the following line to disable HTTPS,
        SERVER_NAME: ':80'
        MERCURE_PUBLISHER_JWT_KEY: '!ChangeThisMercureHubJWTSecretKey!'
        MERCURE_SUBSCRIBER_JWT_KEY: '!ChangeThisMercureHubJWTSecretKey!'
        # Set the URL of your Symfony project (without trailing slash!) as value of the cors_origins directive
        MERCURE_EXTRA_DIRECTIVES: |
          cors_origins http://localhost:8081
      # Comment the following line to disable the development mode
      command: /usr/bin/caddy run --config /etc/caddy/dev.Caddyfile
      ports:
        - "8082:80"
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8082/healthz"]
        timeout: 5s
        retries: 5
        start_period: 60s
      volumes:
        - ./mercure/data:/data
        - ./mercure/config:/config
      networks:
        - statistics-for-strava-network

networks:
    statistics-for-strava-network: {}
